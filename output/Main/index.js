// Generated by purs version 0.13.8
"use strict";
var $foreign = require("./foreign.js");
var Control_Applicative = require("../Control.Applicative/index.js");
var Control_Apply = require("../Control.Apply/index.js");
var Control_Bind = require("../Control.Bind/index.js");
var Data_Argonaut_Core = require("../Data.Argonaut.Core/index.js");
var Data_Argonaut_Decode_Class = require("../Data.Argonaut.Decode.Class/index.js");
var Data_Argonaut_Encode_Class = require("../Data.Argonaut.Encode.Class/index.js");
var Data_Argonaut_Parser = require("../Data.Argonaut.Parser/index.js");
var Data_Array = require("../Data.Array/index.js");
var Data_Boolean = require("../Data.Boolean/index.js");
var Data_DateTime = require("../Data.DateTime/index.js");
var Data_DateTime_Instant = require("../Data.DateTime.Instant/index.js");
var Data_Either = require("../Data.Either/index.js");
var Data_Eq = require("../Data.Eq/index.js");
var Data_Foldable = require("../Data.Foldable/index.js");
var Data_Function = require("../Data.Function/index.js");
var Data_Functor = require("../Data.Functor/index.js");
var Data_Maybe = require("../Data.Maybe/index.js");
var Data_Monoid = require("../Data.Monoid/index.js");
var Data_Ord = require("../Data.Ord/index.js");
var Data_Posix_Signal = require("../Data.Posix.Signal/index.js");
var Data_Semigroup = require("../Data.Semigroup/index.js");
var Data_Set = require("../Data.Set/index.js");
var Data_Show = require("../Data.Show/index.js");
var Data_String_CodePoints = require("../Data.String.CodePoints/index.js");
var Data_String_CodeUnits = require("../Data.String.CodeUnits/index.js");
var Data_String_Common = require("../Data.String.Common/index.js");
var Data_Traversable = require("../Data.Traversable/index.js");
var Data_Tuple = require("../Data.Tuple/index.js");
var Data_Version = require("../Data.Version/index.js");
var Effect = require("../Effect/index.js");
var Effect_Console = require("../Effect.Console/index.js");
var Effect_Exception = require("../Effect.Exception/index.js");
var Effect_Now = require("../Effect.Now/index.js");
var Effect_Ref = require("../Effect.Ref/index.js");
var Foreign_Object = require("../Foreign.Object/index.js");
var Node_ChildProcess = require("../Node.ChildProcess/index.js");
var Node_Encoding = require("../Node.Encoding/index.js");
var Node_FS_Stats = require("../Node.FS.Stats/index.js");
var Node_FS_Sync = require("../Node.FS.Sync/index.js");
var Node_Path = require("../Node.Path/index.js");
var Node_Platform = require("../Node.Platform/index.js");
var Node_Process = require("../Node.Process/index.js");
var Node_Stream = require("../Node.Stream/index.js");
var Psa_Output = require("../Psa.Output/index.js");
var Psa_Printer_Default = require("../Psa.Printer.Default/index.js");
var Psa_Printer_Json = require("../Psa.Printer.Json/index.js");
var Psa_Types = require("../Psa.Types/index.js");
var Stdout = (function () {
    function Stdout() {

    };
    Stdout.value = new Stdout();
    return Stdout;
})();
var Stderr = (function () {
    function Stderr() {

    };
    Stderr.value = new Stderr();
    return Stderr;
})();
var usage = "psa - Error/Warning reporting frontend for 'purs compile'\x0a\x0aUsage: psa [--censor-lib] [--censor-src]\x0a           [--censor-codes=CODES] [--filter-codes=CODES]\x0a           [--no-colors] [--no-source]\x0a           [--is-lib=DIR] [--purs=PURS] [--stash]\x0a           PSC_OPTIONS\x0a\x0aAvailable options:\x0a  -v,--version           Show the version number\x0a  -h,--help              Show this help text\x0a  --verbose-stats        Show counts for each warning type\x0a  --censor-stats         Censor warning/error summary\x0a  --censor-warnings      Censor all warnings\x0a  --censor-lib           Censor warnings from library sources\x0a  --censor-src           Censor warnings from project sources\x0a  --censor-codes=CODES   Censor specific error codes\x0a  --filter-codes=CODES   Only show specific error codes\x0a  --no-colors            Disable ANSI colors\x0a  --no-source            Disable original source code printing\x0a  --strict               Promotes src warnings to errors\x0a  --stash                Enable persistent warnings (defaults to .psa-stash)\x0a  --stash=FILE           Enable persistent warnings using a specific stash file\x0a  --is-lib=DIR           Distinguishing library path (defaults to 'bower_components')\x0a  --purs=PURS            Name of purs executable (defaults to 'purs')\x0a\x0a  CODES                  Comma-separated list of purs error codes\x0a  PSC_OPTIONS            Any extra options are passed to 'purs compile'\x0a";
var parseOptions = function (opts) {
    return function (args) {
        var isPrefix = function (s) {
            return function (str) {
                var v = Data_String_CodePoints.indexOf(s)(str);
                if (v instanceof Data_Maybe.Just && v.value0 === 0) {
                    return true;
                };
                return false;
            };
        };
        var parse = function (p) {
            return function (arg) {
                if (arg === "--version" || arg === "-v") {
                    return Control_Apply.applySecond(Effect.applyEffect)(Effect_Console.log($foreign.version))(Node_Process.exit(0));
                };
                if (arg === "--help" || arg === "-h") {
                    return Control_Apply.applySecond(Effect.applyEffect)(Effect_Console.log(usage))(Node_Process.exit(0));
                };
                if (arg === "--stash") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        stash: true,
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        opts: p.opts,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--json-errors") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        jsonErrors: true,
                        stash: p.stash,
                        showSource: p.showSource,
                        opts: p.opts,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--no-source") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        showSource: false,
                        jsonErrors: p.jsonErrors,
                        stash: p.stash,
                        opts: p.opts,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--no-colors" || arg === "--monochrome") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            ansi: false,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            censorWarnings: p.opts.censorWarnings,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--verbose-stats") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            statVerbosity: Psa_Types.VerboseStats.value,
                            ansi: p.opts.ansi,
                            strict: p.opts.strict,
                            censorWarnings: p.opts.censorWarnings,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--censor-stats") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            statVerbosity: Psa_Types.NoStats.value,
                            ansi: p.opts.ansi,
                            strict: p.opts.strict,
                            censorWarnings: p.opts.censorWarnings,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--strict") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            strict: true,
                            ansi: p.opts.ansi,
                            statVerbosity: p.opts.statVerbosity,
                            censorWarnings: p.opts.censorWarnings,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--censor-warnings") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            censorWarnings: true,
                            ansi: p.opts.ansi,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--censor-lib") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            censorLib: true,
                            ansi: p.opts.ansi,
                            censorWarnings: p.opts.censorWarnings,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            censorSrc: p.opts.censorSrc,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (arg === "--censor-src") {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            censorSrc: true,
                            ansi: p.opts.ansi,
                            censorLib: p.opts.censorLib,
                            censorWarnings: p.opts.censorWarnings,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            censorCodes: p.opts.censorCodes,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (isPrefix("--censor-codes=")(arg)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            censorCodes: Data_Foldable.foldr(Data_Foldable.foldableArray)(Data_Set.insert(Data_Ord.ordString))(p.opts.censorCodes)(Data_String_Common.split(",")(Data_String_CodePoints.drop(15)(arg))),
                            ansi: p.opts.ansi,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorWarnings: p.opts.censorWarnings,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            filterCodes: p.opts.filterCodes,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (isPrefix("--filter-codes=")(arg)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            filterCodes: Data_Foldable.foldr(Data_Foldable.foldableArray)(Data_Set.insert(Data_Ord.ordString))(p.opts.filterCodes)(Data_String_Common.split(",")(Data_String_CodePoints.drop(15)(arg))),
                            ansi: p.opts.ansi,
                            censorCodes: p.opts.censorCodes,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorWarnings: p.opts.censorWarnings,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            libDirs: p.opts.libDirs,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (isPrefix("--is-lib=")(arg)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        opts: {
                            libDirs: Data_Array.snoc(p.opts.libDirs)(Data_String_CodePoints.drop(9)(arg)),
                            ansi: p.opts.ansi,
                            censorCodes: p.opts.censorCodes,
                            censorLib: p.opts.censorLib,
                            censorSrc: p.opts.censorSrc,
                            censorWarnings: p.opts.censorWarnings,
                            filterCodes: p.opts.filterCodes,
                            statVerbosity: p.opts.statVerbosity,
                            strict: p.opts.strict,
                            cwd: p.opts.cwd
                        },
                        jsonErrors: p.jsonErrors,
                        showSource: p.showSource,
                        stash: p.stash,
                        purs: p.purs,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (isPrefix("--purs=")(arg)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        purs: Data_String_CodePoints.drop(7)(arg),
                        jsonErrors: p.jsonErrors,
                        opts: p.opts,
                        showSource: p.showSource,
                        stash: p.stash,
                        stashFile: p.stashFile,
                        extra: p.extra
                    });
                };
                if (isPrefix("--stash=")(arg)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        stash: true,
                        stashFile: Data_String_CodePoints.drop(8)(arg),
                        jsonErrors: p.jsonErrors,
                        opts: p.opts,
                        purs: p.purs,
                        showSource: p.showSource,
                        extra: p.extra
                    });
                };
                if (Data_Boolean.otherwise) {
                    return Control_Applicative.pure(Effect.applicativeEffect)({
                        extra: Data_Array.snoc(p.extra)(arg),
                        jsonErrors: p.jsonErrors,
                        opts: p.opts,
                        purs: p.purs,
                        showSource: p.showSource,
                        stash: p.stash,
                        stashFile: p.stashFile
                    });
                };
                throw new Error("Failed pattern match at Main (line 82, column 3 - line 134, column 60): " + [ p.constructor.name, arg.constructor.name ]);
            };
        };
        var defaultLibDir = function (x) {
            if (Data_Array.length(x.opts.libDirs) === 0) {
                return {
                    opts: {
                        libDirs: [ "bower_components", ".spago" ],
                        ansi: x.opts.ansi,
                        censorCodes: x.opts.censorCodes,
                        censorLib: x.opts.censorLib,
                        censorSrc: x.opts.censorSrc,
                        censorWarnings: x.opts.censorWarnings,
                        cwd: x.opts.cwd,
                        filterCodes: x.opts.filterCodes,
                        statVerbosity: x.opts.statVerbosity,
                        strict: x.opts.strict
                    },
                    extra: x.extra,
                    jsonErrors: x.jsonErrors,
                    purs: x.purs,
                    showSource: x.showSource,
                    stash: x.stash,
                    stashFile: x.stashFile
                };
            };
            if (Data_Boolean.otherwise) {
                return x;
            };
            throw new Error("Failed pattern match at Main (line 141, column 3 - line 144, column 20): " + [ x.constructor.name ]);
        };
        return Data_Functor.map(Effect.functorEffect)(defaultLibDir)(Data_Array.foldM(Effect.monadEffect)(parse)({
            extra: [  ],
            purs: "purs",
            showSource: true,
            stash: false,
            stashFile: ".psa-stash",
            jsonErrors: false,
            opts: opts
        })(args));
    };
};
var defaultOptions = {
    ansi: true,
    censorWarnings: false,
    censorLib: false,
    censorSrc: false,
    censorCodes: Data_Set.empty,
    filterCodes: Data_Set.empty,
    statVerbosity: Psa_Types.CompactStats.value,
    libDirs: [  ],
    strict: false,
    cwd: ""
};
var main = (function () {
    var mergeWarnings = function (filenames) {
        return function (date) {
            return function (old) {
                return function ($$new) {
                    return function __do() {
                        var fileStat = Effect_Ref["new"](Foreign_Object.empty)();
                        var old$prime = Data_Function.flip(Data_Array.filterA(Effect.applicativeEffect))(old)(function (x) {
                            if (x.filename instanceof Data_Maybe.Nothing) {
                                return Control_Applicative.pure(Effect.applicativeEffect)(false);
                            };
                            if (x.filename instanceof Data_Maybe.Just) {
                                var $55 = Data_Set.member(Data_Ord.ordString)(x.filename.value0)(filenames);
                                if ($55) {
                                    return Control_Applicative.pure(Effect.applicativeEffect)(false);
                                };
                                return function __do() {
                                    var stat = Data_Functor.map(Effect.functorEffect)(Foreign_Object.lookup(x.filename.value0))(Effect_Ref.read(fileStat))();
                                    if (stat instanceof Data_Maybe.Just) {
                                        return stat.value0;
                                    };
                                    if (stat instanceof Data_Maybe.Nothing) {
                                        var s = Effect_Exception.catchException(function (v) {
                                            return Control_Applicative.pure(Effect.applicativeEffect)(false);
                                        })(Data_Functor.map(Effect.functorEffect)(function ($101) {
                                            return (function (v) {
                                                return Data_Ord.greaterThan(Data_DateTime.ordDateTime)(date)(v);
                                            })(Node_FS_Stats.modifiedTime($101));
                                        })(Node_FS_Sync.stat(x.filename.value0)))();
                                        Effect_Ref.modify_(Foreign_Object.insert(x.filename.value0)(s))(fileStat)();
                                        return s;
                                    };
                                    throw new Error("Failed pattern match at Main (line 302, column 15 - line 308, column 25): " + [ stat.constructor.name ]);
                                };
                            };
                            throw new Error("Failed pattern match at Main (line 295, column 7 - line 308, column 25): " + [ x.filename.constructor.name ]);
                        })();
                        return Data_Semigroup.append(Data_Semigroup.semigroupArray)(old$prime)($$new);
                    };
                };
            };
        };
    };
    var loadNothing = function (v) {
        return function (v1) {
            return Control_Applicative.pure(Effect.applicativeEffect)(Data_Maybe.Nothing.value);
        };
    };
    var isEmptySpan = function (filename) {
        return function (pos) {
            return filename === "" || pos.startLine === 0 && (pos.endLine === 0 && (pos.startColumn === 0 && pos.endColumn === 0));
        };
    };
    var loadLines = function (files) {
        return function (filename) {
            return function (pos) {
                if (isEmptySpan(filename)(pos)) {
                    return Control_Applicative.pure(Effect.applicativeEffect)(Data_Maybe.Nothing.value);
                };
                if (Data_Boolean.otherwise) {
                    return Effect_Exception.catchException(Data_Function["const"](Control_Applicative.pure(Effect.applicativeEffect)(Data_Maybe.Nothing.value)))(function __do() {
                        var cache = Data_Functor.map(Effect.functorEffect)(Foreign_Object.lookup(filename))(Effect_Ref.read(files))();
                        var contents = (function () {
                            if (cache instanceof Data_Maybe.Just) {
                                return cache.value0;
                            };
                            if (cache instanceof Data_Maybe.Nothing) {
                                var lines = Data_Functor.map(Effect.functorEffect)(Data_String_Common.split("\x0a"))(Node_FS_Sync.readTextFile(Node_Encoding.UTF8.value)(filename))();
                                Effect_Ref.modify_(Foreign_Object.insert(filename)(lines))(files)();
                                return lines;
                            };
                            throw new Error("Failed pattern match at Main (line 266, column 11 - line 271, column 25): " + [ cache.constructor.name ]);
                        })();
                        var source = Data_Array.slice(pos.startLine - 1 | 0)(pos.endLine)(contents);
                        return new Data_Maybe.Just(source);
                    });
                };
                throw new Error("Failed pattern match at Main (line 261, column 3 - line 273, column 27): " + [ files.constructor.name, filename.constructor.name, pos.constructor.name ]);
            };
        };
    };
    var insertFilenames = Data_Foldable.foldr(Data_Foldable.foldableArray)(function (x) {
        return function (s) {
            return Data_Maybe.maybe(s)(Data_Function.flip(Data_Set.insert(Data_Ord.ordString))(s))(x.filename);
        };
    });
    var fillBuffer = function (buffer) {
        return function (stream) {
            return Node_Stream.onDataString(stream)(Node_Encoding.UTF8.value)(function (chunk) {
                return Effect_Ref.modify_(function (v) {
                    return v + chunk;
                })(buffer);
            });
        };
    };
    var spawn$prime = function (outputStream) {
        return function (cmd) {
            return function (args) {
                return function (onExit) {
                    var stdio = (function () {
                        if (outputStream instanceof Stdout) {
                            return [ new Data_Maybe.Just(Node_ChildProcess.Pipe.value), new Data_Maybe.Just(Node_ChildProcess.Pipe.value), Node_ChildProcess["inherit"][2] ];
                        };
                        if (outputStream instanceof Stderr) {
                            return [ new Data_Maybe.Just(Node_ChildProcess.Pipe.value), Node_ChildProcess["inherit"][1], new Data_Maybe.Just(Node_ChildProcess.Pipe.value) ];
                        };
                        throw new Error("Failed pattern match at Main (line 204, column 11 - line 206, column 110): " + [ outputStream.constructor.name ]);
                    })();
                    return function __do() {
                        var child = Node_ChildProcess.spawn(cmd)(args)({
                            cwd: Node_ChildProcess.defaultSpawnOptions.cwd,
                            stdio: stdio,
                            env: Node_ChildProcess.defaultSpawnOptions.env,
                            detached: Node_ChildProcess.defaultSpawnOptions.detached,
                            uid: Node_ChildProcess.defaultSpawnOptions.uid,
                            gid: Node_ChildProcess.defaultSpawnOptions.gid
                        })();
                        var buffer = Effect_Ref["new"]("")();
                        fillBuffer(buffer)((function () {
                            if (outputStream instanceof Stdout) {
                                return Node_ChildProcess.stdout(child);
                            };
                            if (outputStream instanceof Stderr) {
                                return Node_ChildProcess.stderr(child);
                            };
                            throw new Error("Failed pattern match at Main (line 211, column 7 - line 213, column 37): " + [ outputStream.constructor.name ]);
                        })())();
                        Node_ChildProcess.onExit(child)(function (status) {
                            if (status instanceof Node_ChildProcess.Normally) {
                                return function __do() {
                                    var output = Effect_Ref.read(buffer)();
                                    return onExit({
                                        output: output,
                                        exitCode: status.value0
                                    })();
                                };
                            };
                            if (status instanceof Node_ChildProcess.BySignal) {
                                return function __do() {
                                    Effect_Console.error(Data_Show.show(Data_Posix_Signal.showSignal)(status.value0))();
                                    return Node_Process.exit(1)();
                                };
                            };
                            throw new Error("Failed pattern match at Main (line 215, column 7 - line 221, column 25): " + [ status.constructor.name ]);
                        })();
                        return Node_ChildProcess.onError(child)(retryWithCmd(outputStream)(cmd)(args)(onExit))();
                    };
                };
            };
        };
    };
    var retryWithCmd = function (outputStream) {
        return function (cmd) {
            return function (args) {
                return function (onExit) {
                    return function (err) {
                        if (err.code === "ENOENT") {
                            var $74 = Data_Eq.eq(Data_Maybe.eqMaybe(Node_Platform.eqPlatform))(Node_Process.platform)(new Data_Maybe.Just(Node_Platform.Win32.value));
                            if ($74) {
                                var v = Data_String_CodeUnits.stripSuffix(".cmd")(cmd);
                                if (v instanceof Data_Maybe.Nothing) {
                                    return spawn$prime(outputStream)(cmd + ".cmd")(args)(onExit);
                                };
                                if (v instanceof Data_Maybe.Just) {
                                    return Effect_Exception["throw"]("`" + (v.value0 + ("` executable not found. (nor `" + (cmd + "`)"))));
                                };
                                throw new Error("Failed pattern match at Main (line 247, column 10 - line 249, column 101): " + [ v.constructor.name ]);
                            };
                            return Effect_Exception["throw"]("`" + (cmd + "` executable not found."));
                        };
                        if (Data_Boolean.otherwise) {
                            return Effect_Exception.throwException(Node_ChildProcess.toStandardError(err));
                        };
                        throw new Error("Failed pattern match at Main (line 242, column 3 - line 253, column 50): " + [ outputStream.constructor.name, cmd.constructor.name, args.constructor.name, onExit.constructor.name, err.constructor.name ]);
                    };
                };
            };
        };
    };
    var readPursVersion = function (purs) {
        return function (cb) {
            return spawn$prime(Stdout.value)(purs)([ "--version" ])(function (v) {
                var verStr = Data_String_CodePoints.takeWhile(function (v1) {
                    return Data_Eq.notEq(Data_String_CodePoints.eqCodePoint)(v1)(Data_String_CodePoints.codePointFromChar(" "));
                })(Data_String_Common.trim(v.output));
                var v1 = Data_Version.parseVersion(verStr);
                if (v1 instanceof Data_Either.Right) {
                    return cb(v1.value0);
                };
                if (v1 instanceof Data_Either.Left) {
                    return Effect_Exception["throw"](Data_Foldable.fold(Data_Foldable.foldableArray)(Data_Monoid.monoidString)([ "Unable to parse the version from `purs`. (Saw: ", verStr, "). Please check that the right executable is on your PATH." ]));
                };
                throw new Error("Failed pattern match at Main (line 232, column 7 - line 240, column 14): " + [ v1.constructor.name ]);
            });
        };
    };
    var encodeStash = function (s) {
        return Data_Argonaut_Encode_Class.encodeJson(Data_Argonaut_Encode_Class.encodeJsonArray(Data_Argonaut_Encode_Class.encodeJsonJson))(Data_Functor.map(Data_Functor.functorArray)(Psa_Types.encodePsaError)(s));
    };
    var writeStashFile = function (stashFile) {
        return function (warnings) {
            var file = Data_Argonaut_Core.stringify(encodeStash(warnings));
            return Node_FS_Sync.writeTextFile(Node_Encoding.UTF8.value)(stashFile)(file);
        };
    };
    var emptyStash = Data_Functor.map(Effect.functorEffect)(Data_Functor.map(Data_Functor.functorFn)(function (v) {
        return {
            date: v,
            stash: [  ]
        };
    })(Data_DateTime_Instant.toDateTime))(Effect_Now.now);
    var decodeStash = function (s) {
        return Control_Bind.bind(Data_Either.bindEither)(Control_Bind.bind(Data_Either.bindEither)(Data_Argonaut_Parser.jsonParser(s))(Data_Argonaut_Decode_Class.decodeJson(Data_Argonaut_Decode_Class.decodeArray(Data_Argonaut_Decode_Class.decodeForeignObject(Data_Argonaut_Decode_Class.decodeJsonJson)))))(Data_Traversable.traverse(Data_Traversable.traversableArray)(Data_Either.applicativeEither)(Psa_Types.parsePsaError));
    };
    var readStashFile = function (stashFile) {
        return Effect_Exception.catchException(Data_Function["const"](emptyStash))(function __do() {
            var stat = Node_FS_Sync.stat(stashFile)();
            var file = Node_FS_Sync.readTextFile(Node_Encoding.UTF8.value)(stashFile)();
            var v = decodeStash(file);
            if (v instanceof Data_Either.Left) {
                return emptyStash();
            };
            if (v instanceof Data_Either.Right) {
                return {
                    date: Node_FS_Stats.modifiedTime(stat),
                    stash: v.value0
                };
            };
            throw new Error("Failed pattern match at Main (line 284, column 5 - line 286, column 67): " + [ v.constructor.name ]);
        });
    };
    return Data_Functor["void"](Effect.functorEffect)(function __do() {
        var cwd = Node_Process.cwd();
        var argv = Data_Functor.map(Effect.functorEffect)(Data_Array.drop(2))(Node_Process.argv)();
        var v = parseOptions({
            ansi: defaultOptions.ansi,
            censorWarnings: defaultOptions.censorWarnings,
            censorLib: defaultOptions.censorLib,
            censorSrc: defaultOptions.censorSrc,
            censorCodes: defaultOptions.censorCodes,
            filterCodes: defaultOptions.filterCodes,
            statVerbosity: defaultOptions.statVerbosity,
            libDirs: defaultOptions.libDirs,
            strict: defaultOptions.strict,
            cwd: cwd
        })(argv)();
        var libDirs = Data_Traversable.traverse(Data_Traversable.traversableArray)(Effect.applicativeEffect)((function () {
            var $102 = Data_Functor.map(Effect.functorEffect)(function (v1) {
                return v1 + Node_Path.sep;
            });
            var $103 = Node_Path.resolve([ cwd ]);
            return function ($104) {
                return $102($103($104));
            };
        })())(v.opts.libDirs)();
        var opts$prime = {
            libDirs: libDirs,
            ansi: v.opts.ansi,
            censorCodes: v.opts.censorCodes,
            censorLib: v.opts.censorLib,
            censorSrc: v.opts.censorSrc,
            censorWarnings: v.opts.censorWarnings,
            cwd: v.opts.cwd,
            filterCodes: v.opts.filterCodes,
            statVerbosity: v.opts.statVerbosity,
            strict: v.opts.strict
        };
        var args = Data_Array.cons("compile")(Data_Array.cons("--json-errors")(v.extra));
        var stashData = (function () {
            if (v.stash) {
                return readStashFile(v.stashFile)();
            };
            return emptyStash();
        })();
        return readPursVersion(v.purs)(function (pursVer) {
            var outputStream = (function () {
                var $87 = Data_Ord.greaterThanOrEq(Data_Tuple.ordTuple(Data_Ord.ordInt)(Data_Ord.ordInt))(new Data_Tuple.Tuple(Data_Version.major(pursVer), Data_Version.minor(pursVer)))(new Data_Tuple.Tuple(0, 14));
                if ($87) {
                    return Stdout.value;
                };
                return Stderr.value;
            })();
            return spawn$prime(outputStream)(v.purs)(args)(function (pursResult) {
                return Data_Foldable.for_(Effect.applicativeEffect)(Data_Foldable.foldableArray)(Data_String_Common.split("\x0a")(pursResult.output))(function (err) {
                    var v1 = Control_Bind.bind(Data_Either.bindEither)(Control_Bind.bind(Data_Either.bindEither)(Data_Argonaut_Parser.jsonParser(err))(Data_Argonaut_Decode_Class.decodeJson(Data_Argonaut_Decode_Class.decodeForeignObject(Data_Argonaut_Decode_Class.decodeJsonJson))))(Psa_Types.parsePsaResult);
                    if (v1 instanceof Data_Either.Left) {
                        return Effect_Console.error(err);
                    };
                    if (v1 instanceof Data_Either.Right) {
                        return function __do() {
                            var files = Effect_Ref["new"](Foreign_Object.empty)();
                            var loadLinesImpl = (function () {
                                if (v.showSource) {
                                    return loadLines(files);
                                };
                                return loadNothing;
                            })();
                            var filenames = insertFilenames(insertFilenames(Data_Set.empty)(v1.value0.errors))(v1.value0.warnings);
                            var merged = mergeWarnings(filenames)(stashData.date)(stashData.stash)(v1.value0.warnings)();
                            Control_Applicative.when(Effect.applicativeEffect)(v.stash)(writeStashFile(v.stashFile)(merged))();
                            var out$prime = Psa_Output.output(Effect.monadEffect)(loadLinesImpl)(opts$prime)({
                                warnings: merged,
                                errors: v1.value0.errors
                            })();
                            (function () {
                                if (v.jsonErrors) {
                                    return Psa_Printer_Json.print(out$prime)();
                                };
                                return Psa_Printer_Default.print(opts$prime)(out$prime)();
                            })();
                            var $92 = Foreign_Object.isEmpty(out$prime.stats.allErrors);
                            if ($92) {
                                return Node_Process.exit(pursResult.exitCode)();
                            };
                            return Node_Process.exit(1)();
                        };
                    };
                    throw new Error("Failed pattern match at Main (line 182, column 9 - line 196, column 34): " + [ v1.constructor.name ]);
                });
            });
        })();
    });
})();
module.exports = {
    defaultOptions: defaultOptions,
    parseOptions: parseOptions,
    main: main,
    Stdout: Stdout,
    Stderr: Stderr,
    usage: usage,
    version: $foreign.version
};
